# Packet Labs IoT workshop

This workshop deploys compute, storage, networking, and an IoT application to Packet.com.

## Conceptual architecture

Diagram:

![Conceptual architecture](/docs/images/conceptual.png)

Private components:

* Kubernetes - provisioned with [Terraform](https://www.terraform.io)
* TLS termination - via [cert-manager](https://cert-manager.io)
* MQTT Connector - [openfaas-incubator/mqtt-connector](https://github.com/openfaas-incubator/mqtt-connector)
* Database/storage - [Postgresql](https://www.postgresql.org)
* Docker registry - deployed externally, i.e. the Docker Hub.

Components exposed with TLS / Ingress or NodePort:

* Ingress Controller - [Traefik v1](https://github.com/containous/traefik) (HostPort 80/443)
* Serverless compute platform - [OpenFaaS](https://github.com/openfaas/faas)
* MQTT Broker - [emitter.io](https://emitter.io) (NodePort) - 30080/30443
* Business intelligence - [Metabase](https://www.metabase.com) (Ingress/TLS)
* Metrics visualization - [Grafana](https://grafana.com) (Ingress/TLS)

## Getting started

Before you begin using this repo you will need a [Packet](https://app.packet.net/signup) account.

Everything else you need to deploy this workshop is available in this repository.

> Note: This repository is designed to be used with your own domain name and a number of DNS records. This enables TLS termination (HTTPS) to be used for exposed services. If you are working in development, you can skip the domain and TLS steps. 

> You can register for a domain at [Google Domains](https://domains.google) or [Namecheap.com](https://namecheap.com) for a few dollars. You can also configure your domain there, after purchase.

### 1) Clone the repo

```sh
git clone https://github.com/packet-labs/iot
```

### 2) Create a bare-metal Kubernetes cluster and deploy the application

You will use [Terraform](https://www.terraform.io) to [create the cluster and deploy components](/k8s/).  Once complete find the IP for one of the cluster nodes in terraform output, your Packet dashboard or the `.tfstate` file in /k8s/

Create four DNS A records using the IP (replace `example.com` with your domain):

* A `gateway.example.com` - IP
* A `grafana.example.com` - IP
* A `metabase.example.com` - IP
* A `emitter.example.com` - IP

### 3) Generate Drone Data

You can now send data to emitter from drone clients.  Use the [drone simulator](/test/client/) to generate realistic data for use with visualization tools.

### 4) Visualize the Data

Drones can be monitored in realtime by visiting 


### 1) Install Postgres via KubeDB and helm

You will need to install helm for this step.

* Install [postgresql](/postgresql/)

### 1) Install OpenFaaS

* Install [openfaas](/openfaas/) to provide compute and events

* Deploy the [OpenFaaS services](/openfaas/services/) for the application

You will also deploy the [schema.sql](/openfaas/services/schema.sql) at this time for `drone_position` and `drone_event`.

### 1) TLS for OpenFaaS

* Install cert-manager

    ```sh
    k3sup app install cert-manager
    ```

* Install an Ingress record for your OpenFaaS gateway

    ```sh
    k3sup app install openfaas-ingress \
    --domain gateway.example.com \
    --email openfaas@example.com \
    --ingress-class traefik
    ```

* Add TLS for Grafana

    Edit `./openfaas/grafana-ingress.yaml` and edit `grafana.example.com` replacing `example.com` with your domain.

    Now run:

    ```sh
    kubectl apply -f ./openfaas/grafana-ingress.yaml
    ```

### 1) Add the MQTT Broker (Emitter.io)

* Install [emitter](/emitter/)

### 1) Add the OpenFaaS MQTT-Connector

The MQTT-Connector is used to trigger functions and services in response to messages generated by the event source. It runs inside the Kubernetes cluster and is private with no ingress.

* Install [OpenFaaS MQTT-Connector](/openfaas/mqtt-connector/)

### 1) Add Grafana for function/service visualization

Grafana packages a pre-compiled dashboard for OpenFaaS to show metrics like throughput and latency.

* [Deploy and Grafana](/grafana/)

### 1) Send Drone Data

You can now send data to emitter from your drone clients.  Use the [drone simulator](/test/client/) to generate realistic data for use with visualization tools.
